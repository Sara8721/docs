# rDEX Introduction

## Overview

rDEX V1 is a DEX developed by StaFi that seeks to solve the problems associated with rToken liquidity. It will provide decentralized transaction services for all rTokens based on the StaFi Chain. Being an important part of the StaFi rToken ecosystem, rDEX V1 will be deployed on the StaFi chain. Native rTokens minted by users can directly be traded through the DEX for better liquidity. 
This will eliminate the need for cross-chain to Ethereum or other ecosystems.rDEX V1 has the following features:
- Low slippage in small and medium-sized transactions, which is realized through the AMM CLP market maker model.
- FIS as the basic trading asset for all rToken trading pairs to promote liquidity.
- Impermanence loss protection, whereby the loss incurred by Liquidity Provider will be compensated by FIS token.
- Liquidity can be provided by any single currency or a dual-currency model with different ratios.

## Liquidity Pool Model

StaFi rDEX V1 will be developed with reference to Thorchain's Continuous Liquidity Pools (CLP) model. We have chosen this as this offers the following advantages compared to Uniswap's AMM model:
- Slippage protection mechanism. When the user's transaction scale is relatively low compared to the pool liquidity scale, the slippage is lower. On the contrary, if the transaction scale is relatively high compared to the pool liquidity scale, the transaction slippage will be rather high. As a result, whales will not be able to drain the liquidity of rToken.
- Promote liquidity. Since each trading pair needs to use FIS as the basic transaction asset, each pool can establish considerable liquidity through FIS. Every pool can use FIS as a medium to realize the exchange between different rToken assets, or rToken assets with Native Tokens.
- Support the liquidity of any single currency or any ratio of dual token deposit. Users can deposit a single token type or two different kinds of tokens in any ratio, in order to support the liquidity of the transaction. There is no need to deposit two assets at the same time at a ratio of 50%-50%, like in the case of Uniswap.

 ### AMM CLP Model

 The market maker formula for user transactions under the AMM CLP Model is as follows:

 $$y={xYX}/{(x+X)^2}$$

 Where: 
- ùíô:Input amount of Token A
- ùíö:Output amount of Token B
- ùëã:Balance of Token A in the input side of the pool before swap
- ùëå:Balance of Token B in the input side of the pool before swap

By Delphi Digital‚Äôs research, the slippage is lower under the CLP market maker model when compared with the Uniswap AMM model. This is when the transaction is of a small or medium-sized scale, and vice versa. The comparison of transaction slippage between CLP model and AMM model is shown in the figure below:

![rdex](/image/rdexintro_1.png)

### Liquidity Provider Fee

Under the CLP market maker mechanism, the Liquidity Fee charged by the StaFi rDEX V1 Liquidity Provider is calculated as follows:

$$Liquidity Fee={x^2Y}/{(x+Y)^2}$$

Where:

- ùíô:Input amount of Token A
- ùíö:Output amount of Token B
- ùëã:Balance of Token A in the input side of the pool before swap
- ùëå:Balance of Token B in the input side of the pool before swap

The Liquidity Provider Fee of rDEX V1 is flexible (in comparison, Uniswap's default is 0.3%), and is adjusted by the slippage generated by the user during the transaction. Therefore, when the transaction scale is larger, the slippage will increase accordingly, and more Liquidity Provider Fee will be charged.

This model provides the following benefits:
- Large-scale transactions will no longer be lucrative. In other words, small and medium-scale transactions will be encouraged;
- Traditionally, a fixed Liquidity Provider Fee, say 0.3%, cannot encourage Liquidity Providers to actively provide liquidity when large-scale transactions occur. On the other hand, this method will be able to do that. Liquidity Provider Fee mechanism based on slippage is adopted to give liquidity providers higher returns in the case of large-scale transactions in the pool, and even incentivize more liquidity providers to join. Even whales will not be able to have a drastic impact on the liquidity of the Pool.

### Different Deposit Types

Most DEXs, such by Uniswap, require users to provide dual tokens at a ratio of 50%-50% when providing liquidity. This limits users' motivation and increases the transaction cost of Liquidity Providers to some extent.

rDEX V1 will allow Liquidity providers to support liquidity with one single token. If they offer two, they will be provided the flexibility to decide the ratio. This will also help them save intermediate transaction costs.


### Pool Share

When users provide liquidity for rDEX V1, it needs to calculate the liquidity Pool Share provided by them. The Pool Share calculation formula taking into account the slippage adjustment is as follows:

$$PoolShare=[P(Fr+fR)/2FR]*\left(1-|(Fr-fR)/[(F+f*(R+r))]|\right)$$

Where:

- ùëì:The deposited amount of FIS token
- ùëü:The deposited amount of rToken
- ùë≠:Balance of FIS token in the pool before depositing liquidity
- ùëπ:Balance of rToken in the pool before depositing liquidity
- ùëÉ:Existing pool Share

## Impermanent Loss Protection

When a Liquidity Provider faces market-making decisions, the most worrying concern is impermanent loss. In extreme cases, it may be greater than the Liquidity Provider Fee income. Therefore, rDEX V1 will provide an impermanent loss protection mechanism - the value of assets while withdrawing is not lower than what it was when depositing if the Liquidity Provider serves for a certain period of time (say, 100 days).

For example, a user called Alice provides 100 rATOM and 2000 FIS as liquidity for the rATOM/FIS trading pair on Day1 (when the price of the oracle is 1 rATOM=20 FIS).Assuming that after Day 60, the price of the oracle is 1 rATOM=30 FIS, and the assets of Alice's Pool share become 80 rATOM and 2400FIS, with a total value of 4800 FIS.

Although the total value of FIS of Alice's Pool share is rising, the value of its redeemable assets has fallen relative to the value of assets that do not provide liquidity after 2 months.
- After providing liquidity, the asset redemption on Day 60 will be 80 rATOM and 2400 FIS, and the total value will be 4800 FIS.
- If liquidity is not provided, on Day60, Alice still holds 100 rATOM and 2000 FIS, and the total value is 100*30+2000=5000 FIS.

After Alice has provided liquidity, the total value of assets has dropped by 200FIS (5000FIS-4800FIS) compared to what it would have been for simply holding rATOM and FIS.

In order to make up for the possible impermanence losses of Liquidity Providers like Alice, StaFi will set up an Impermanent Loss Protection Reserve to issue FIS to Alice as compensation.

The compensation can be calculated by:

$$P1=F1/R1$$

$$Compensation=(R0*P1+F0)-(R1*P1+F1)$$

Where:

- ùë≠0:The amount of FIS token deposited by Alice on Day 0
- ùëπ0:The amount of rToken deposited by Alice on Day 0
- ùë≠1:The amount of FIS token to redeem by Alice on Day N
- ùëπ1:The amount of rToken to redeem by Alice on Day N
- ùëÉ1:The oracle price of rToken against FIS on Day N

## Participants

rDEX V1 Key participants include traders and liquidity providers:1ÔºâTrader A trader can exchange one token for another token through rDEX V1 using the price determined by the liquidity pool ratio.2ÔºâLiquidity ProviderLiquidity provider adds rToken or FIS token to their corresponding rDEX V1 pair pool to earn liquidity provider fees as revenues or liquidity mining rewards. 

## Trading Pairs and Fees

rDEX V1 will support trading pairs between rToken and FIS, such as rATOM/FIS, rDOT/FIS, rKSM/FIS, rSOL/FIS, rBNB/FIS, rMATIC/FIS, etc. In the future, all rTokens supported by StaFi will be listed.

The Fee types supported by rDEX V1 are mainly Liquidity Provider Fee and Gas Fee:

![rdex](/image/rdexintro_2.png)

## FIS Utility

rDEX V1 will drastically promote FIS Utility through the following aspects:
- The basic transaction assets of rToken in rDEX V1 are all FIS, which will become an important medium to promote the liquidity of rToken.
- Since rDEX V1 is directly deployed on the StaFi chain, users need to pay FIS as a gas fee when using rDEX V1.
- FIS will be used for Impermanent Loss Protection Fund Reserve to motivate Liquidity Providers.
- FIS will be used for rDEX V1 liquidity mining incentives.
- FIS will be used by community members to vote for the liquidity mining weight of each rToken pool.
- The transaction fee income of rDEX V1 will be collected by the Treasury and used for the Buyback and burning of FIS.

## Future Work

rDEX V1 will not be the end of the story, just like rSwap V1 wasn‚Äôt. On the contrary, it is just the prelude of the StaFi team building liquidity for rToken Holders. After rDEX V1 is rolled out, the core StaFi team members will continue exploring the following areas:1) Support Native Token cross-chain to StaFi Chain, and build Native Token/FIS trading pairs. On that basis, users can trade between rTokens and Native Tokens.2) Explore the IDO of new rToken assets, so that when a new rToken is listed in the future, users of rDEX V1 can directly use Native Tokens to purchase rToken assets at a certain discount.3) Establish a FIS liquidity mining reward pool to encourage users to vote by FIS for the distribution of the FIS liquidity pool among different rToken pools.


---

## rDEX V2

With rDEX V2(testnet), StaFiHub users can trade the rTokens issued on StaFiHub against the base token, like rATOM against ATOM, and not the rATOM against FIS token on StaFi Chain. We think that this new feature will greatly improve the capital efficiency of liquidity providers and create a friendly arbitrage mechanism to help peg the rToken trading price with the real on-chain exchange rate. For now, rDEX V2 testnet supports 2 trading pairs: rATOM/ATOM and rIRIS/IRIS.

rDEX is very important for StaFi protocol‚Äôs staking derivative eco as the decentralized trading platform for all the rTokens. rDEX V2 has the following new features:
- Trading rTokens against base tokens: Compared with rDEX V1, rDEX V2 supports trading between rTokens issued on StaFiHub and the base token.
- Continuous Liquidity: rDEX is an automated market maker DEX to provide continuous liquidity for rTokens by utilizing Thorchain‚Äôs CLP market maker model.
- Lower Slippage: rDEX ensures low slippage for small and medium-sized transactions by using the fee model based on slippage.
- Asymmetrical Deposit: Unlike the majority of cryptocurrency liquidity pools, rDEX users can provide liquidity by depositing one token or two tokens asymmetrically.